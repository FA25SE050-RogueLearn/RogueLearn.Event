<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>EventHub & RoomHub Complete Test Suite</title>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: #333;
                padding: 20px;
            }

            .container {
                max-width: 1400px;
                margin: 0 auto;
            }

            h1 {
                text-align: center;
                color: white;
                margin-bottom: 30px;
                font-size: 2.5em;
                text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            }

            .grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
                gap: 20px;
                margin-bottom: 20px;
            }

            .card {
                background: white;
                border-radius: 15px;
                padding: 25px;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            }

            .card h2 {
                color: #667eea;
                margin-bottom: 20px;
                padding-bottom: 10px;
                border-bottom: 2px solid #667eea;
                font-size: 1.5em;
            }

            .form-group {
                margin-bottom: 15px;
            }

            label {
                display: block;
                margin-bottom: 5px;
                font-weight: 600;
                color: #555;
            }

            input,
            textarea,
            select {
                width: 100%;
                padding: 10px;
                border: 2px solid #ddd;
                border-radius: 8px;
                font-size: 14px;
                transition: border-color 0.3s;
            }

            input:focus,
            textarea:focus,
            select:focus {
                outline: none;
                border-color: #667eea;
            }

            button {
                width: 100%;
                padding: 12px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                border: none;
                border-radius: 8px;
                font-size: 16px;
                font-weight: 600;
                cursor: pointer;
                transition:
                    transform 0.2s,
                    box-shadow 0.2s;
                margin-top: 10px;
            }

            button:disabled {
                background: #ccc;
                cursor: not-allowed;
            }

            button:hover:not(:disabled) {
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            }

            button:active:not(:disabled) {
                transform: translateY(0);
            }

            button.danger {
                background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            }

            button.success {
                background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            }

            .status {
                padding: 12px;
                border-radius: 8px;
                margin: 10px 0;
                font-weight: 600;
                text-align: center;
            }

            .status.connected {
                background: #d4edda;
                color: #155724;
                border: 1px solid #c3e6cb;
            }

            .status.disconnected {
                background: #f8d7da;
                color: #721c24;
                border: 1px solid #f5c6cb;
            }

            .status.warning {
                background: #fff3cd;
                color: #856404;
                border: 1px solid #ffeaa7;
            }

            .countdown {
                font-size: 3em;
                font-weight: bold;
                text-align: center;
                margin: 20px 0;
                padding: 20px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                border-radius: 15px;
                font-family: "Courier New", monospace;
                text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            }

            .countdown.warning {
                background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
                animation: pulse 1s infinite;
            }

            .countdown.critical {
                background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
                animation: blink 0.5s infinite;
            }

            @keyframes pulse {
                0%,
                100% {
                    transform: scale(1);
                }
                50% {
                    transform: scale(1.05);
                }
            }

            @keyframes blink {
                0%,
                50% {
                    opacity: 1;
                }
                51%,
                100% {
                    opacity: 0.7;
                }
            }

            .log {
                background: #1e1e1e;
                color: #00ff00;
                padding: 15px;
                border-radius: 8px;
                max-height: 300px;
                overflow-y: auto;
                font-family: "Courier New", monospace;
                font-size: 12px;
                margin-top: 15px;
            }

            .log-entry {
                margin: 5px 0;
                padding: 5px;
                border-left: 3px solid #00ff00;
                padding-left: 10px;
            }

            .log-entry.error {
                border-left-color: #ff4444;
                color: #ff4444;
            }

            .log-entry.warning {
                border-left-color: #ffaa00;
                color: #ffaa00;
            }

            .log-entry.info {
                border-left-color: #4444ff;
                color: #4444ff;
            }

            .leaderboard {
                margin-top: 15px;
            }

            .leaderboard table {
                width: 100%;
                border-collapse: collapse;
            }

            .leaderboard th {
                background: #667eea;
                color: white;
                padding: 10px;
                text-align: left;
            }

            .leaderboard td {
                padding: 10px;
                border-bottom: 1px solid #ddd;
            }

            .status-dot {
                display: inline-block;
                width: 10px;
                height: 10px;
                border-radius: 50%;
                margin-right: 8px;
            }

            .status-dot.present {
                background-color: #28a745;
                box-shadow: 0 0 4px #28a745;
            }

            .status-dot.disconnected {
                background-color: #dc3545;
                box-shadow: 0 0 4px #dc3545;
            }

            .status-dot.completed {
                background-color: #6c757d;
                box-shadow: 0 0 4px #6c757d;
            }

            .status-dot.left {
                background-color: #ffc107;
                box-shadow: 0 0 4px #ffc107;
            }

            .leaderboard tr:hover {
                background: #f5f5f5;
            }

            .leaderboard .rank-1 {
                background: #ffd700;
            }

            .leaderboard .rank-2 {
                background: #c0c0c0;
            }

            .leaderboard .rank-3 {
                background: #cd7f32;
            }

            .info-box {
                background: #e3f2fd;
                border-left: 4px solid #2196f3;
                padding: 15px;
                margin: 15px 0;
                border-radius: 5px;
            }

            .info-box strong {
                color: #1976d2;
            }

            .event-info {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 10px;
                margin: 15px 0;
            }

            .event-info-item {
                background: #f5f5f5;
                padding: 10px;
                border-radius: 8px;
            }

            .event-info-item strong {
                color: #667eea;
            }

            .code-editor {
                font-family: "Courier New", monospace;
                font-size: 14px;
                min-height: 200px;
            }

            .tabs {
                display: flex;
                gap: 10px;
                margin-bottom: 15px;
                border-bottom: 2px solid #ddd;
            }

            .tab {
                padding: 10px 20px;
                cursor: pointer;
                border: none;
                background: transparent;
                color: #666;
                font-weight: 600;
                transition: all 0.3s;
                border-bottom: 3px solid transparent;
                width: auto;
            }

            .tab.active {
                color: #667eea;
                border-bottom-color: #667eea;
            }

            .tab-content {
                display: none;
            }

            .tab-content.active {
                display: block;
            }

            .submission-result {
                animation: slideIn 0.3s ease-out;
            }

            @keyframes slideIn {
                from {
                    opacity: 0;
                    transform: translateY(-10px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>üéÆ EventHub & RoomHub Complete Test Suite</h1>

            <!-- Configuration Section -->
            <div class="card">
                <h2>‚öôÔ∏è Configuration</h2>
                <div class="form-group">
                    <label>API Base URL</label>
                    <input
                        type="text"
                        id="apiUrl"
                        value="http://localhost:8084"
                    />
                </div>
                <div class="form-group">
                    <label>Bearer Token (JWT)</label>
                    <textarea
                        id="bearerToken"
                        rows="3"
                        placeholder="Paste your JWT token here..."
                    ></textarea>
                </div>
                <div class="form-group">
                    <label>Event ID</label>
                    <input
                        type="text"
                        id="eventId"
                        value="48909fba-ede2-47ae-9d61-f7de09718f31"
                    />
                </div>
                <div class="form-group">
                    <label>Room ID</label>
                    <div style="display: flex; gap: 10px">
                        <select id="roomId" style="flex-grow: 1" disabled>
                            <option value="">
                                Enter Event ID and click Fetch
                            </option>
                        </select>
                        <button
                            id="fetchRoomsBtn"
                            onclick="fetchRooms()"
                            style="
                                width: auto;
                                margin-top: 0;
                                height: 43px;
                                align-self: end;
                            "
                        >
                            Fetch Rooms
                        </button>
                    </div>
                </div>
            </div>

            <div class="grid">
                <!-- Room SSE Connection -->
                <div class="card">
                    <h2>üîå Room SSE Connection</h2>
                    <div id="roomStatus" class="status disconnected">
                        Disconnected
                    </div>

                    <div class="countdown" id="countdown">--:--:--</div>

                    <div class="event-info">
                        <div class="event-info-item">
                            <strong>Event ID:</strong><br />
                            <span id="displayEventId">-</span>
                        </div>
                        <div class="event-info-item">
                            <strong>End Date:</strong><br />
                            <span id="endDate">-</span>
                        </div>
                        <div class="event-info-item">
                            <strong>Seconds Left:</strong><br />
                            <span id="secondsLeft">-</span>
                        </div>
                        <div class="event-info-item">
                            <strong>Server Time:</strong><br />
                            <span id="serverTime">-</span>
                        </div>
                    </div>

                    <button onclick="connectToRoom()">Connect to Room</button>
                    <button class="danger" onclick="disconnectFromRoom()">
                        Disconnect
                    </button>

                    <h3 style="margin-top: 20px">Room Event Log</h3>
                    <div class="log" id="roomLog"></div>
                </div>

                <!-- Event SSE Connection (Guild Leaderboard) -->
                <div class="card">
                    <h2>üìä Event SSE Connection (Spectator)</h2>
                    <div id="eventStatus" class="status disconnected">
                        Disconnected
                    </div>

                    <button onclick="connectToEvent()">
                        Connect to Event (Spectator Mode)
                    </button>
                    <button class="danger" onclick="disconnectFromEvent()">
                        Disconnect
                    </button>

                    <h3 style="margin-top: 20px">Event Event Log</h3>
                    <div class="log" id="eventLog"></div>
                </div>
            </div>

            <div class="grid">
                <!-- Room Leaderboard -->
                <div class="card">
                    <h2>üèÜ Room Leaderboard</h2>
                    <div class="leaderboard">
                        <table id="roomLeaderboard">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Player</th>
                                    <th>Score</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="roomLeaderboardBody">
                                <tr>
                                    <td
                                        colspan="4"
                                        style="text-align: center; color: #999"
                                    >
                                        No data yet
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Guild Leaderboard -->
                <div class="card">
                    <h2>üèÖ Guild Leaderboard</h2>
                    <div class="leaderboard">
                        <table id="guildLeaderboard">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Guild</th>
                                    <th>Score</th>
                                </tr>
                            </thead>
                            <tbody id="guildLeaderboardBody">
                                <tr>
                                    <td
                                        colspan="3"
                                        style="text-align: center; color: #999"
                                    >
                                        No data yet
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Code Submission -->
            <div class="card">
                <h2>üíª Code Submission</h2>

                <div class="form-group">
                    <label>Select Problem</label>
                    <div style="display: flex; gap: 10px">
                        <select
                            id="problemSelect"
                            style="flex-grow: 1"
                            disabled
                        >
                            <option value="">
                                Connect to room first to load problems
                            </option>
                        </select>
                        <button
                            id="fetchProblemsBtn"
                            onclick="fetchProblems()"
                            style="
                                width: auto;
                                margin-top: 0;
                                height: 43px;
                                align-self: end;
                            "
                            disabled
                        >
                            Fetch Problems
                        </button>
                    </div>
                </div>

                <div class="form-group">
                    <label>Language</label>
                    <select id="language">
                        <option value="Golang">Golang</option>
                        <option value="Python">Python</option>
                        <option value="Javascript">Javascript</option>
                    </select>
                </div>

                <div
                    style="
                        display: grid;
                        grid-template-columns: 1fr 1fr;
                        gap: 20px;
                        margin-top: 15px;
                    "
                >
                    <!-- Problem Details -->
                    <div>
                        <h3 style="margin-bottom: 10px; color: #667eea">
                            Problem Details
                        </h3>
                        <div
                            id="problemDetails"
                            style="
                                background: #f5f5f5;
                                padding: 15px;
                                border-radius: 8px;
                                min-height: 300px;
                                max-height: 500px;
                                overflow-y: auto;
                            "
                        >
                            <p
                                style="
                                    color: #999;
                                    text-align: center;
                                    margin-top: 50px;
                                "
                            >
                                Select a problem to view details
                            </p>
                        </div>
                    </div>

                    <!-- Code Editor -->
                    <div>
                        <h3 style="margin-bottom: 10px; color: #667eea">
                            Your Code
                        </h3>
                        <div class="form-group">
                            <textarea
                                id="codeSubmit"
                                class="code-editor"
                                placeholder="// Select a problem and write your solution here"
                                style="min-height: 300px; max-height: 500px"
                            ></textarea>
                        </div>
                    </div>
                </div>

                <button class="success" onclick="submitSolution()">
                    Submit Solution
                </button>

                <!-- Submission Result Display -->
                <div
                    id="submissionResult"
                    class="submission-result"
                    style="margin-top: 20px; display: none"
                >
                    <h3 style="margin-bottom: 10px; color: #667eea">
                        Submission Result
                    </h3>
                    <div
                        id="submissionResultContent"
                        style="padding: 15px; border-radius: 8px"
                    ></div>
                </div>
            </div>

            <!-- Testing Instructions -->
            <div class="card">
                <h2>üìã Complete Testing Guide</h2>

                <div class="info-box">
                    <strong>‚ö†Ô∏è Prerequisites:</strong>
                    <ul style="margin-top: 10px; margin-left: 20px">
                        <li>
                            Service must be running on http://localhost:8084
                        </li>
                        <li>
                            Database must have the test event and rooms
                            configured
                        </li>
                        <li>RabbitMQ must be running and connected</li>
                        <li>
                            <strong>Authentication:</strong> You need a valid
                            JWT Bearer Token. For SSE connections (Room and
                            Event), the token is sent via a query parameter
                            (`auth_token`), which is a common workaround for
                            `EventSource` limitations.
                        </li>
                    </ul>
                </div>

                <h3>Test Scenarios</h3>

                <div style="margin-top: 15px">
                    <h4 style="color: #667eea; margin-bottom: 10px">
                        1Ô∏è‚É£ Test Initial Time & Countdown (Client-Side)
                    </h4>
                    <ol style="margin-left: 20px; line-height: 1.8">
                        <li>Click "Connect to Room"</li>
                        <li>
                            <strong>Expected:</strong> Receive
                            <code>initial_time</code> event with end_date,
                            seconds_left, formatted_time, server_time
                        </li>
                        <li>
                            <strong>Expected:</strong> Countdown starts ticking
                            down every second (client-side)
                        </li>
                        <li>
                            <strong>Expected:</strong> Countdown changes color
                            at 5 min (warning) and 1 min (critical)
                        </li>
                    </ol>
                </div>

                <div style="margin-top: 15px">
                    <h4 style="color: #667eea; margin-bottom: 10px">
                        2Ô∏è‚É£ Test Player Join/Leave Events
                    </h4>
                    <ol style="margin-left: 20px; line-height: 1.8">
                        <li>
                            Open this page in
                            <strong>two browser windows</strong>
                        </li>
                        <li>Use different Player IDs in each window</li>
                        <li>Connect both to the same room</li>
                        <li>
                            <strong>Expected:</strong> Both receive
                            <code>PLAYER_JOINED</code> events
                        </li>
                        <li>
                            <strong>Expected:</strong> Room leaderboard updates
                            automatically
                        </li>
                        <li>Close one window</li>
                        <li>
                            <strong>Expected:</strong> Other window receives
                            <code>PLAYER_LEFT</code> event
                        </li>
                    </ol>
                </div>

                <div style="margin-top: 15px">
                    <h4 style="color: #667eea; margin-bottom: 10px">
                        3Ô∏è‚É£ Test Code Submission & Leaderboard Update
                    </h4>
                    <ol style="margin-left: 20px; line-height: 1.8">
                        <li>
                            Click "View Problems" tab to see available problems
                        </li>
                        <li>Copy a problem ID</li>
                        <li>Go to "Submit Solution" tab</li>
                        <li>Enter problem ID and write code</li>
                        <li>Click "Submit Solution"</li>
                        <li>
                            <strong>Expected:</strong> Code sent to executor
                            service via gRPC
                        </li>
                        <li>
                            <strong>Expected:</strong> Receive
                            <code>SOLUTION_SUBMITTED</code> event
                        </li>
                        <li>
                            <strong>Expected (if correct):</strong> Receive
                            <code>CORRECT_SOLUTION_SUBMITTED</code> event
                        </li>
                        <li>
                            <strong>Expected:</strong> Room leaderboard updates
                            via <code>LEADERBOARD_UPDATED</code> event
                        </li>
                        <li>
                            <strong>Expected:</strong> Guild leaderboard updates
                            via <code>GUILD_LEADERBOARD_UPDATED</code> event
                        </li>
                    </ol>
                </div>

                <div style="margin-top: 15px">
                    <h4 style="color: #667eea; margin-bottom: 10px">
                        4Ô∏è‚É£ Test Multi-Instance RabbitMQ Distribution
                    </h4>
                    <ol style="margin-left: 20px; line-height: 1.8">
                        <li>
                            Start <strong>two instances</strong> of the service
                            (different ports: 8084, 8085)
                        </li>
                        <li>Connect Player A to instance 1 (port 8084)</li>
                        <li>Connect Player B to instance 2 (port 8085)</li>
                        <li>Player A submits a solution</li>
                        <li>
                            <strong>Expected:</strong> Instance 1 publishes to
                            RabbitMQ
                        </li>
                        <li>
                            <strong>Expected:</strong> Both instances receive
                            the message from RabbitMQ
                        </li>
                        <li>
                            <strong>Expected:</strong> Both Player A and Player
                            B see leaderboard update
                        </li>
                    </ol>
                </div>

                <div style="margin-top: 15px">
                    <h4 style="color: #667eea; margin-bottom: 10px">
                        5Ô∏è‚É£ Test Event Expiry Timer
                    </h4>
                    <ol style="margin-left: 20px; line-height: 1.8">
                        <li>
                            Create an event with end_date = 2 minutes from now
                        </li>
                        <li>
                            Process the event (activate it) via
                            <code>/internal/start-pending-events</code>
                        </li>
                        <li>
                            <strong>Expected:</strong> Timer scheduled via
                            <code>ScheduleEventExpiry()</code>
                        </li>
                        <li>Connect to the room</li>
                        <li>Wait for countdown to reach zero</li>
                        <li>
                            <strong>Expected:</strong>
                            <code>time.AfterFunc()</code> fires
                        </li>
                        <li>
                            <strong>Expected:</strong>
                            <code>completeEvent()</code> atomically updates DB
                            to 'completed'
                        </li>
                        <li>
                            <strong>Expected:</strong>
                            <code>EVENT_EXPIRED</code> published to RabbitMQ
                        </li>
                        <li>
                            <strong>Expected:</strong> All connected players
                            receive event expired message
                        </li>
                        <li>
                            <strong>Expected:</strong> Alert shown: "Event has
                            ended. Thank you for participating!"
                        </li>
                    </ol>
                </div>

                <div style="margin-top: 15px">
                    <h4 style="color: #667eea; margin-bottom: 10px">
                        6Ô∏è‚É£ Test Event Recovery on Restart
                    </h4>
                    <ol style="margin-left: 20px; line-height: 1.8">
                        <li>Create an event that ends in 10 minutes</li>
                        <li>Activate the event</li>
                        <li><strong>Restart the service</strong></li>
                        <li>
                            <strong>Expected:</strong>
                            <code>recoverActiveEvents()</code> called in
                            <code>NewEventHub()</code>
                        </li>
                        <li>
                            <strong>Expected:</strong> Query finds active event
                            in database
                        </li>
                        <li>
                            <strong>Expected:</strong> Timer re-scheduled with
                            <code>time.Until(endDate)</code>
                        </li>
                        <li>Wait for event to expire</li>
                        <li>
                            <strong>Expected:</strong> Event expires correctly
                            despite restart
                        </li>
                    </ol>
                </div>

                <div style="margin-top: 15px">
                    <h4 style="color: #667eea; margin-bottom: 10px">
                        7Ô∏è‚É£ Test Lazy-Loading Room Hub
                    </h4>
                    <ol style="margin-left: 20px; line-height: 1.8">
                        <li>
                            Start instance 1 and activate an event (creates
                            rooms in DB)
                        </li>
                        <li>Start instance 2 (fresh, no rooms in memory)</li>
                        <li>Player connects to instance 2</li>
                        <li>
                            <strong>Expected:</strong>
                            <code>GetOrCreateRoomHub()</code> queries DB for
                            room
                        </li>
                        <li>
                            <strong>Expected:</strong> RoomHub created in memory
                            on instance 2
                        </li>
                        <li>
                            <strong>Expected:</strong> If event is active, timer
                            scheduled via <code>ScheduleEventExpiry()</code>
                        </li>
                        <li>Player submits code to instance 2</li>
                        <li>
                            <strong>Expected:</strong> RabbitMQ broadcasts to
                            both instances
                        </li>
                    </ol>
                </div>

                <div style="margin-top: 15px">
                    <h4 style="color: #667eea; margin-bottom: 10px">
                        8Ô∏è‚É£ Test Guild Leaderboard Spectator Mode
                    </h4>
                    <ol style="margin-left: 20px; line-height: 1.8">
                        <li>Click "Connect to Event (Spectator Mode)"</li>
                        <li>
                            <strong>Expected:</strong> Connect to
                            <code>/events/{event_id}/sse</code>
                        </li>
                        <li>
                            <strong>Expected:</strong> Receive initial guild
                            leaderboard state
                        </li>
                        <li>Submit solutions in different rooms</li>
                        <li>
                            <strong>Expected:</strong> Receive
                            <code>GUILD_LEADERBOARD_UPDATED</code> events
                        </li>
                        <li>
                            <strong>Expected:</strong> Guild leaderboard table
                            updates in real-time
                        </li>
                    </ol>
                </div>

                <div style="margin-top: 15px">
                    <h4 style="color: #667eea; margin-bottom: 10px">
                        9Ô∏è‚É£ Test Atomic Leaderboard Calculation
                    </h4>
                    <ol style="margin-left: 20px; line-height: 1.8">
                        <li>
                            Open 3 browser windows, all connected to same room
                        </li>
                        <li>
                            Submit solutions from all 3 players
                            <strong>simultaneously</strong>
                        </li>
                        <li>
                            <strong>Expected:</strong> Each submission wrapped
                            in transaction with <code>SELECT FOR UPDATE</code>
                        </li>
                        <li>
                            <strong>Expected:</strong> No race conditions,
                            rankings calculated correctly
                        </li>
                        <li>
                            <strong>Expected:</strong> All players see
                            consistent leaderboard state
                        </li>
                    </ol>
                </div>

                <div style="margin-top: 15px">
                    <h4 style="color: #667eea; margin-bottom: 10px">
                        üîü Test Room Deletion & Cleanup
                    </h4>
                    <ol style="margin-left: 20px; line-height: 1.8">
                        <li>Connect to a room</li>
                        <li>
                            Send <code>ROOM_DELETED</code> event (via admin API
                            or database)
                        </li>
                        <li>
                            <strong>Expected:</strong> Receive
                            <code>ROOM_DELETED</code> event
                        </li>
                        <li>
                            <strong>Expected:</strong> Room removed from
                            database
                        </li>
                        <li>
                            <strong>Expected:</strong> All connected players
                            notified
                        </li>
                    </ol>
                </div>
            </div>
        </div>

        <script>
            // Global state
            let roomEventSource = null;
            let eventEventSource = null;
            let countdownInterval = null;
            let eventEndTime = null;
            let problemsData = []; // Store fetched problems

            // Logging utilities
            function addLog(logId, message, type = "info") {
                const log = document.getElementById(logId);
                const entry = document.createElement("div");
                entry.className = `log-entry ${type}`;
                const timestamp = new Date().toLocaleTimeString();
                entry.textContent = `[${timestamp}] ${message}`;
                log.appendChild(entry);
                log.scrollTop = log.scrollHeight;
            }

            function clearLog(logId) {
                document.getElementById(logId).innerHTML = "";
            }

            // Problem selection handler
            function onProblemSelected() {
                const problemSelect = document.getElementById("problemSelect");
                const selectedIndex = problemSelect.selectedIndex;

                if (selectedIndex > 0) {
                    // Not the placeholder option
                    const problem = problemsData[selectedIndex - 1];
                    displayProblemDetails(problem);
                }
            }

            // Display submission result
            function displaySubmissionResult(result, isCorrect) {
                const resultDiv = document.getElementById("submissionResult");
                const contentDiv = document.getElementById(
                    "submissionResultContent",
                );

                resultDiv.style.display = "block";

                if (isCorrect) {
                    contentDiv.style.background = "#d4edda";
                    contentDiv.style.border = "2px solid #28a745";
                    contentDiv.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 2em;">‚úÖ</span>
                            <div>
                                <h4 style="color: #155724; margin: 0;">Accepted!</h4>
                                <p style="margin: 5px 0 0 0; color: #155724;">
                                    ${result.Message || result.message || "Your solution is correct!"}
                                </p>
                                ${result.Score || result.score ? `<p style="margin: 5px 0 0 0; color: #155724;"><strong>Score: +${result.Score || result.score} points</strong></p>` : ""}
                            </div>
                        </div>
                    `;
                } else {
                    contentDiv.style.background = "#f8d7da";
                    contentDiv.style.border = "2px solid #dc3545";

                    const status = result.Status || result.status || "Error";
                    const message =
                        result.Message ||
                        result.message ||
                        "Your solution has errors.";

                    let statusEmoji = "‚ùå";
                    let statusColor = "#721c24";

                    if (
                        status === "Compilation Error" ||
                        status === "CompilationError"
                    ) {
                        statusEmoji = "üîß";
                    } else if (
                        status === "Runtime Error" ||
                        status === "RuntimeError"
                    ) {
                        statusEmoji = "‚ö†Ô∏è";
                    } else if (
                        status === "Wrong Answer" ||
                        status === "WrongAnswer"
                    ) {
                        statusEmoji = "‚ùå";
                    }

                    contentDiv.innerHTML = `
                        <div style="display: flex; align-items: start; gap: 10px;">
                            <span style="font-size: 2em;">${statusEmoji}</span>
                            <div style="flex: 1;">
                                <h4 style="color: ${statusColor}; margin: 0;">${status}</h4>
                                <p style="margin: 5px 0 0 0; color: ${statusColor}; white-space: pre-wrap; font-family: 'Courier New', monospace; font-size: 13px;">
                                    ${message}
                                </p>
                            </div>
                        </div>
                    `;
                }

                // Auto-hide after 10 seconds
                setTimeout(() => {
                    resultDiv.style.display = "none";
                }, 10000);
            }

            function displayProblemDetails(problem) {
                const detailsDiv = document.getElementById("problemDetails");
                // Handle both lowercase and uppercase field names
                const title =
                    problem.title || problem.Title || "Untitled Problem";
                const difficulty =
                    problem.difficulty || problem.Difficulty || "Medium";
                const score = problem.score || problem.Score || 100;
                const statement =
                    problem.problem_statement ||
                    problem.ProblemStatement ||
                    problem.statement ||
                    problem.Statement ||
                    "No problem statement available";

                detailsDiv.innerHTML = `
                    <h4 style="color: #667eea; margin-bottom: 10px;">${title}</h4>
                    <div style="margin-bottom: 10px;">
                        <span style="background: #667eea; color: white; padding: 3px 8px; border-radius: 5px; font-size: 12px; margin-right: 5px;">
                            ${difficulty}
                        </span>
                        <span style="background: #4facfe; color: white; padding: 3px 8px; border-radius: 5px; font-size: 12px;">
                            Score: ${score}
                        </span>
                    </div>
                    <div style="margin-top: 15px; line-height: 1.6;">
                        <strong>Problem Statement:</strong>
                        <p style="margin-top: 10px; white-space: pre-wrap;">${statement}</p>
                    </div>
                `;
            }

            // Countdown utilities
            function formatTime(seconds) {
                const hours = Math.floor(seconds / 3600);
                const minutes = Math.floor((seconds % 3600) / 60);
                const secs = seconds % 60;
                return `${hours.toString().padStart(2, "0")}:${minutes.toString().padStart(2, "0")}:${secs.toString().padStart(2, "0")}`;
            }

            function updateCountdown() {
                if (!eventEndTime) return;

                const now = new Date();
                const remaining = Math.max(
                    0,
                    Math.floor((eventEndTime - now) / 1000),
                );

                const formatted = formatTime(remaining);
                const countdownEl = document.getElementById("countdown");
                countdownEl.textContent = formatted;

                document.getElementById("secondsLeft").textContent =
                    remaining + "s";

                // Update styling
                countdownEl.classList.remove("warning", "critical");
                if (remaining < 300 && remaining > 60) {
                    countdownEl.classList.add("warning");
                } else if (remaining <= 60 && remaining > 0) {
                    countdownEl.classList.add("critical");
                }

                // Stop at zero
                if (remaining === 0) {
                    clearInterval(countdownInterval);
                    addLog("roomLog", "‚è±Ô∏è Countdown reached zero!", "warning");
                }
            }

            // Function to fetch rooms for an event
            async function fetchRooms() {
                const apiUrl = document.getElementById("apiUrl").value;
                const eventId = document.getElementById("eventId").value;
                const roomSelect = document.getElementById("roomId");
                const fetchBtn = document.getElementById("fetchRoomsBtn");
                const token = document.getElementById("bearerToken").value;

                if (!eventId) {
                    alert("Please enter an Event ID.");
                    return;
                }

                roomSelect.innerHTML = "<option>Fetching rooms...</option>";
                roomSelect.disabled = true;
                fetchBtn.disabled = true;

                try {
                    // This endpoint is public, so no auth needed
                    const response = await fetch(
                        `${apiUrl}/events/${eventId}/rooms?auth_token=${token}`,
                    );
                    const result = await response.json();

                    if (
                        response.ok &&
                        result.success &&
                        Array.isArray(result.data)
                    ) {
                        roomSelect.innerHTML = ""; // Clear options
                        if (result.data.length === 0) {
                            roomSelect.innerHTML =
                                '<option value="">No rooms found for this event</option>';
                        } else {
                            result.data.forEach((room) => {
                                const option = document.createElement("option");
                                option.value = room.ID;
                                option.textContent = room.Name;
                                roomSelect.appendChild(option);
                            });
                            roomSelect.disabled = false;
                        }
                    } else {
                        roomSelect.innerHTML = `<option value="">Error: ${result.msg || "Could not fetch rooms"}</option>`;
                    }
                } catch (error) {
                    console.error("Error fetching rooms:", error);
                    roomSelect.innerHTML =
                        '<option value="">Failed to fetch rooms</option>';
                } finally {
                    fetchBtn.disabled = false;
                }
            }

            // Room SSE Connection
            function connectToRoom() {
                const apiUrl = document.getElementById("apiUrl").value;
                const token = document.getElementById("bearerToken").value;
                const eventId = document.getElementById("eventId").value;
                const roomId = document.getElementById("roomId").value;

                if (!roomId) {
                    alert("Please fetch and select a room first.");
                    return;
                }

                if (!token) {
                    alert("Please enter a Bearer Token to authenticate.");
                    return;
                }

                if (roomEventSource) {
                    roomEventSource.close();
                    addLog("roomLog", "Closed previous connection");
                }

                if (countdownInterval) {
                    clearInterval(countdownInterval);
                }

                clearLog("roomLog");

                // No need for connected_player_id - extracted from token on server
                let url = `${apiUrl}/events/${eventId}/rooms/${roomId}/sse?auth_token=${encodeURIComponent(token)}`;
                console.log(
                    `Connecting to: ${url.split("?")[0]}?auth_token=${token}`,
                );

                addLog(
                    "roomLog",
                    `Connecting to: ${url.split("?")[0]}?auth_token=...`,
                );

                roomEventSource = new EventSource(url);

                // Enable fetch problems button after connecting
                document.getElementById("fetchProblemsBtn").disabled = false;

                roomEventSource.addEventListener("initial_time", (event) => {
                    const parsed = JSON.parse(event.data);
                    // Extract the actual data from the SSE event wrapper
                    const data = parsed.Data || parsed.data || parsed;

                    addLog(
                        "roomLog",
                        `‚úÖ Received initial_time: ${data.formatted_time}`,
                        "info",
                    );

                    document.getElementById("displayEventId").textContent =
                        data.event_id;
                    document.getElementById("endDate").textContent = new Date(
                        data.end_date,
                    ).toLocaleString();
                    document.getElementById("serverTime").textContent =
                        new Date(data.server_time).toLocaleTimeString();

                    eventEndTime = new Date(data.end_date);
                    updateCountdown();
                    countdownInterval = setInterval(updateCountdown, 1000);

                    document.getElementById("roomStatus").className =
                        "status connected";
                    document.getElementById("roomStatus").textContent =
                        "Connected - Countdown Active";
                });

                roomEventSource.addEventListener("event_expired", (event) => {
                    const parsed = JSON.parse(event.data);
                    // Extract the actual data from the SSE event wrapper
                    const data = parsed.Data || parsed.data || parsed;

                    addLog(
                        "roomLog",
                        `üèÅ EVENT EXPIRED: ${data.message}`,
                        "warning",
                    );

                    clearInterval(countdownInterval);
                    document.getElementById("countdown").textContent =
                        "00:00:00";
                    document.getElementById("roomStatus").className =
                        "status warning";
                    document.getElementById("roomStatus").textContent =
                        "Event Ended";

                    alert(`Event has ended!\n\n${data.message}`);
                });

                roomEventSource.addEventListener(
                    "LEADERBOARD_UPDATED",
                    (event) => {
                        const data = JSON.parse(event.data);
                        addLog("roomLog", "üìä Leaderboard updated");
                        updateRoomLeaderboard(data);
                    },
                );

                roomEventSource.addEventListener("player_joined", (event) => {
                    const data = JSON.parse(event.data);
                    addLog("roomLog", `üë§ Player joined: ${data.PlayerID}`);
                });

                roomEventSource.addEventListener("player_left", (event) => {
                    const data = JSON.parse(event.data);
                    addLog("roomLog", `üëã Player left: ${data.PlayerID}`);
                });

                roomEventSource.addEventListener(
                    "CORRECT_SOLUTION_SUBMITTED",
                    (event) => {
                        const data = JSON.parse(event.data);
                        console.log("Correct solution data:", data);
                        addLog(
                            "roomLog",
                            `‚úÖ Correct solution! Score: +${data.Score || data.score || 0}`,
                            "info",
                        );
                        displaySubmissionResult(data, true);
                    },
                );

                roomEventSource.addEventListener(
                    "WRONG_SOLUTION_SUBMITTED",
                    (event) => {
                        const data = JSON.parse(event.data);
                        console.log("Wrong solution data:", data);
                        addLog(
                            "roomLog",
                            `‚ùå Wrong solution: ${data.Status || data.status || "Error"}`,
                            "error",
                        );

                        // If data is just a string, convert it to an object
                        const resultObj =
                            typeof data === "string"
                                ? { Status: "Error", Message: data }
                                : data;
                        displaySubmissionResult(resultObj, false);
                    },
                );

                roomEventSource.addEventListener(
                    "SOLUTION_SUBMITTED",
                    (event) => {
                        const data = JSON.parse(event.data);
                        console.log("Solution submitted:", data);
                        addLog(
                            "roomLog",
                            `üìù Solution submitted, processing...`,
                            "info",
                        );
                    },
                );

                roomEventSource.onerror = (error) => {
                    addLog("roomLog", "‚ùå Connection error", "error");
                    document.getElementById("roomStatus").className =
                        "status disconnected";
                    document.getElementById("roomStatus").textContent =
                        "Connection Error";
                };

                roomEventSource.onopen = () => {
                    addLog("roomLog", "üîå SSE connection opened");
                };
            }

            function disconnectFromRoom() {
                if (roomEventSource) {
                    roomEventSource.close();
                    roomEventSource = null;
                    addLog("roomLog", "üîå Disconnected from room");
                    document.getElementById("roomStatus").className =
                        "status disconnected";
                    document.getElementById("roomStatus").textContent =
                        "Disconnected";
                }
                if (countdownInterval) {
                    clearInterval(countdownInterval);
                }
            }

            // Event SSE Connection (Spectator)
            function connectToEvent() {
                const apiUrl = document.getElementById("apiUrl").value;
                const token = document.getElementById("bearerToken").value;
                const eventId = document.getElementById("eventId").value;

                if (eventEventSource) {
                    eventEventSource.close();
                    addLog("eventLog", "Closed previous connection");
                }

                clearLog("eventLog");

                let url = `${apiUrl}/events/${eventId}/sse`;
                if (token) {
                    url += `?auth_token=${encodeURIComponent(token)}`;
                }

                addLog("eventLog", `Connecting to: ${url}`);
                if (!token) {
                    addLog(
                        "eventLog",
                        `Warning: No bearer token provided. Connection will likely fail.`,
                        "warning",
                    );
                }

                eventEventSource = new EventSource(url);

                eventEventSource.addEventListener(
                    "guild_leaderboard_updated",
                    (event) => {
                        const data = JSON.parse(event.data);
                        addLog("eventLog", "üèÖ Guild leaderboard updated");
                        updateGuildLeaderboard(data);
                    },
                );

                eventEventSource.addEventListener("event_expired", (event) => {
                    const parsed = JSON.parse(event.data);
                    // Extract the actual data from the SSE event wrapper
                    const data = parsed.Data || parsed.data || parsed;

                    addLog(
                        "eventLog",
                        `üèÅ EVENT EXPIRED: ${data.message}`,
                        "warning",
                    );
                });

                eventEventSource.onerror = (error) => {
                    addLog("eventLog", "‚ùå Connection error", "error");
                    document.getElementById("eventStatus").className =
                        "status disconnected";
                    document.getElementById("eventStatus").textContent =
                        "Connection Error";
                };

                eventEventSource.onopen = () => {
                    addLog(
                        "eventLog",
                        "üîå SSE connection opened (Spectator Mode)",
                    );
                    document.getElementById("eventStatus").className =
                        "status connected";
                    document.getElementById("eventStatus").textContent =
                        "Connected - Spectating";
                };
            }

            function disconnectFromEvent() {
                if (eventEventSource) {
                    eventEventSource.close();
                    eventEventSource = null;
                    addLog("eventLog", "üîå Disconnected from event");
                    document.getElementById("eventStatus").className =
                        "status disconnected";
                    document.getElementById("eventStatus").textContent =
                        "Disconnected";
                }
            }

            // Leaderboard updates
            function updateRoomLeaderboard(data) {
                console.log(
                    "Leaderboard data received:",
                    data,
                    "Type:",
                    typeof data,
                );
                const tbody = document.getElementById("roomLeaderboardBody");
                tbody.innerHTML = "";

                // Handle if data is an object with a nested array
                let leaderboardArray = data;
                if (data && !Array.isArray(data)) {
                    // Try common nested structures (both lowercase and uppercase)
                    leaderboardArray =
                        data.Data ||
                        data.data ||
                        data.leaderboard ||
                        data.entries ||
                        [];
                    console.log("Extracted array:", leaderboardArray);
                }

                if (
                    !leaderboardArray ||
                    !Array.isArray(leaderboardArray) ||
                    leaderboardArray.length === 0
                ) {
                    tbody.innerHTML =
                        '<tr><td colspan="4" style="text-align: center; color: #999;">No data</td></tr>';
                    return;
                }

                leaderboardArray.forEach((entry, index) => {
                    const tr = document.createElement("tr");
                    const rankClass =
                        index === 0
                            ? "rank-1"
                            : index === 1
                              ? "rank-2"
                              : index === 2
                                ? "rank-3"
                                : "";
                    tr.className = rankClass;

                    // Handle both lowercase and uppercase field names
                    const place = entry.place || entry.Place || index + 1;
                    const playerName =
                        entry.player_name ||
                        entry.PlayerName ||
                        entry.username ||
                        entry.Username ||
                        "Unknown";
                    const score = entry.score || entry.Score || 0;
                    const state = (entry.state || entry.State || "unknown").toLowerCase();

                    // Determine status dot class and text
                    let statusClass = "disconnected"; // default
                    let statusText = "Offline";

                    if (state === "present") {
                        statusClass = "present";
                        statusText = "Online";
                    } else if (state === "disconnected") {
                        statusClass = "disconnected";
                        statusText = "Offline";
                    } else if (state === "completed") {
                        statusClass = "completed";
                        statusText = "Done";
                    } else if (state === "left") {
                        statusClass = "left";
                        statusText = "Left";
                    }

                    tr.innerHTML = `
                    <td>${place}</td>
                    <td>${playerName}</td>
                    <td><strong>${score}</strong></td>
                    <td>
                        <span class="status-dot ${statusClass}"></span>
                        <span style="font-size: 12px; color: #666;">${statusText}</span>
                    </td>
                `;
                    tbody.appendChild(tr);
                });
            }

            function updateGuildLeaderboard(data) {
                console.log("Guild leaderboard data received:", data);
                const tbody = document.getElementById("guildLeaderboardBody");
                tbody.innerHTML = "";

                // Handle if data is an object with a nested array
                let leaderboardArray = data;
                if (data && !Array.isArray(data)) {
                    // Try common nested structures (both lowercase and uppercase)
                    leaderboardArray =
                        data.Data ||
                        data.data ||
                        data.leaderboard ||
                        data.entries ||
                        [];
                }

                if (
                    !leaderboardArray ||
                    !Array.isArray(leaderboardArray) ||
                    leaderboardArray.length === 0
                ) {
                    tbody.innerHTML =
                        '<tr><td colspan="3" style="text-align: center; color: #999;">No data</td></tr>';
                    return;
                }

                leaderboardArray.forEach((entry, index) => {
                    const tr = document.createElement("tr");
                    const rankClass =
                        index === 0
                            ? "rank-1"
                            : index === 1
                              ? "rank-2"
                              : index === 2
                                ? "rank-3"
                                : "";
                    tr.className = rankClass;

                    const rank = entry.rank || entry.Rank || index + 1;
                    const guildName =
                        entry.guild_name ||
                        entry.GuildName ||
                        entry.name ||
                        entry.Name ||
                        "Unknown";
                    const totalScore =
                        entry.total_score ||
                        entry.TotalScore ||
                        entry.score ||
                        entry.Score ||
                        0;

                    tr.innerHTML = `
                    <td>${rank}</td>
                    <td>${guildName}</td>
                    <td><strong>${totalScore}</strong></td>
                `;
                    tbody.appendChild(tr);
                });
            }

            // Fetch problems for the event
            async function fetchProblems() {
                const apiUrl = document.getElementById("apiUrl").value;
                const token = document.getElementById("bearerToken").value;
                const eventId = document.getElementById("eventId").value;
                const problemSelect = document.getElementById("problemSelect");
                const fetchBtn = document.getElementById("fetchProblemsBtn");

                if (!token) {
                    alert("Please enter a Bearer Token.");
                    return;
                }

                problemSelect.innerHTML =
                    "<option>Fetching problems...</option>";
                problemSelect.disabled = true;
                fetchBtn.disabled = true;

                try {
                    const response = await fetch(
                        `${apiUrl}/events/${eventId}/problems`,
                        {
                            headers: {
                                Authorization: `Bearer ${token}`,
                            },
                        },
                    );
                    const result = await response.json();

                    if (
                        response.ok &&
                        result.data &&
                        Array.isArray(result.data)
                    ) {
                        problemsData = result.data;
                        problemSelect.innerHTML =
                            '<option value="">Select a problem...</option>';

                        if (result.data.length === 0) {
                            problemSelect.innerHTML =
                                '<option value="">No problems found for this event</option>';
                        } else {
                            result.data.forEach((problem, index) => {
                                const option = document.createElement("option");
                                // Handle both 'id' and 'ID' field names
                                option.value = problem.id || problem.ID;
                                option.textContent = `${problem.title || problem.Title} (${problem.difficulty || problem.Difficulty || "Medium"} - ${problem.score || problem.Score || 100} pts)`;
                                problemSelect.appendChild(option);
                            });
                            problemSelect.disabled = false;
                            problemSelect.onchange = onProblemSelected;
                        }
                    } else {
                        problemSelect.innerHTML = `<option value="">Error: ${result.msg || "Could not fetch problems"}</option>`;
                    }
                } catch (error) {
                    console.error("Error fetching problems:", error);
                    problemSelect.innerHTML =
                        '<option value="">Failed to fetch problems</option>';
                } finally {
                    fetchBtn.disabled = false;
                }
            }

            // Code submission
            async function submitSolution() {
                const apiUrl = document.getElementById("apiUrl").value;
                const token = document.getElementById("bearerToken").value;
                const eventId = document.getElementById("eventId").value;
                const roomId = document.getElementById("roomId").value;
                const problemSelect = document.getElementById("problemSelect");
                const problemId = problemSelect.value;
                const language = document.getElementById("language").value;
                const code = document.getElementById("codeSubmit").value;

                console.log("problemID = ", problemId);

                if (!roomId) {
                    alert("Please connect to a room first");
                    return;
                }
                if (!problemId) {
                    alert("Please select a problem");
                    return;
                }
                if (!code) {
                    alert("Please write your code");
                    return;
                }

                const url = `${apiUrl}/events/${eventId}/rooms/${roomId}/submit`;

                try {
                    const selectedProblem = problemsData.find(
                        (p) => (p.id || p.ID) === problemId,
                    );
                    const problemTitle =
                        selectedProblem?.title ||
                        selectedProblem?.Title ||
                        problemId;
                    addLog(
                        "roomLog",
                        `üì§ Submitting solution for "${problemTitle}"...`,
                    );

                    const response = await fetch(url, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            Authorization: `Bearer ${token}`,
                        },
                        body: JSON.stringify({
                            problem_id: problemId,
                            language: language,
                            code: code,
                        }),
                    });

                    const result = await response.json();

                    if (response.ok) {
                        addLog(
                            "roomLog",
                            `‚úÖ Solution submitted successfully!`,
                            "info",
                        );
                    } else {
                        addLog(
                            "roomLog",
                            `‚ùå Submission failed: ${result.message || result.msg || "Unknown error"}`,
                            "error",
                        );
                    }
                } catch (error) {
                    addLog(
                        "roomLog",
                        `‚ùå Network error: ${error.message}`,
                        "error",
                    );
                }
            }

            // Cleanup on page unload
            window.onbeforeunload = () => {
                if (roomEventSource) roomEventSource.close();
                if (eventEventSource) eventEventSource.close();
                if (countdownInterval) clearInterval(countdownInterval);
            };
        </script>
    </body>
</html>
